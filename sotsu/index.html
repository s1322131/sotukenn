<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>VR 魔法杖＋先生モデル＋羽つかみ</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
</head>

<body>
  <a-scene vr-mode-ui="enabled: true">

    <!-- 背景 -->
    <a-sky src="back.png" rotation="0 -90 0"></a-sky>

    <!-- カメラ -->
    <a-entity camera look-controls cursor="rayOrigin: mouse"></a-entity>

    <!-- 字幕（スイッチャー） -->
    <a-plane id="subtitle"
             src="teacher1.png"
             position="0 -5 -15"
             rotation="0 0 90"
             width="8"
             height="5"
             transparent="true"
             shader="flat"
             class="interactable"
             subtitle-switcher>
    </a-plane>

    <!-- リセットボタン -->
    <a-plane id="resetBtn"
             position="0 3 -12"
             width="2"
             height="1"
             color="#444"
             class="interactable"
             reset-scene>
      <a-text value="RESET" align="center" color="#fff" position="0 0 0.1"></a-text>
    </a-plane>

    <!-- 右コントローラ -->
    <a-entity id="rightController"
              laser-controls="hand: right"
              raycaster="objects: .interactable; lineColor: red; far: 20"
              class="interactable">
    </a-entity>

    <!-- 杖 -->
    <a-entity id="wand"
              gltf-model="tsue2.glb"
              scale="0.2 0.2 0.2"
              position="0 0 -1.5">

      <a-sphere id="wandGlow"
                radius="0.6"
                color="#88ccff"
                emissive="#88ccff"
                emissiveIntensity="2"
                visible="false"
                position="0 0 0">
      </a-sphere>

      <a-entity id="wandLight"
                light="type: point; intensity: 0; distance: 4; decay: 2"
                position="0 0 0">
      </a-entity>

    </a-entity>

    <!-- 羽（掴める） -->
    <a-entity id="feather"
              class="interactable grab-target"
              gltf-model="hane.glb"
              position="0 -2 -3"
              rotation="0 90 0"
              scale="0.3 0.3 0.3">
    </a-entity>

    <!-- ほうき（字幕つき） -->
    <a-entity id="houki"
              class="interactable houki-target"
              gltf-model="houki1.glb"
              position="10 -3 -3"
              scale="1 1 1"
              subtitle-houki>
    </a-entity>

    <!-- ほうき字幕 -->
    <a-plane id="houkiSubtitle"
             position="10 2 -3"
             rotation="0 90 0"
             width="4"
             height="2.5"
             visible="false"
             material="transparent:true; shader:flat">
    </a-plane>

    <!-- ライト -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>

  </a-scene>

  <!-- 杖ライト（ダブルトリガーでON/OFF） -->
  <script>
    AFRAME.registerComponent('wand-light-control', {
      init: function () {
        const controller = document.querySelector('#rightController');
        const glow = document.querySelector('#wandGlow');
        const light = document.querySelector('#wandLight');

        let on = false;
        let lastClick = 0;
        const threshold = 300;

        controller.addEventListener('triggerdown', () => {
          const now = performance.now();
          if (now - lastClick < threshold) {
            on = !on;
            glow.setAttribute('visible', on);
            light.setAttribute('light', 'intensity', on ? 2 : 0);
          }
          lastClick = now;
        });
      }
    });
  </script>

  <!-- 羽を掴む（本当に浮いてたときのコード） -->
  <script>
    AFRAME.registerComponent('simple-grab', {
      init: function () {
        const controller = document.querySelector('#rightController');
        let grabbingEl = null;

        controller.addEventListener('triggerdown', () => {
          const hits = controller.components.raycaster.intersections;
          if (!hits.length) return;

          const target = hits[0].object.el;
          if (!target.classList.contains("grab-target")) return;

          grabbingEl = target;

          const pos = new THREE.Vector3();
          controller.object3D.getWorldPosition(pos);

          target.setAttribute("animation__lift", {
            property: "position",
            to: `${pos.x} ${pos.y + 0.5} ${pos.z - 0.5}`,
            dur: 400,
            easing: "easeOutQuad"
          });
        });

        controller.addEventListener('triggerup', () => {
          if (!grabbingEl) return;
          grabbingEl.removeAttribute("animation__lift");
          grabbingEl = null;
        });
      }
    });
  </script>

  <!-- ほうき字幕2段階＋引き寄せ -->
  <script>
    AFRAME.registerComponent('subtitle-houki', {
      init: function () {
        const houki = this.el;
        const subtitle = document.querySelector('#houkiSubtitle');
        const controller = document.querySelector('#rightController');

        let step = 0;

        // ① レイが当たったら字幕①
        houki.addEventListener('raycaster-intersected', () => {
          if (step === 0) {
            subtitle.setAttribute('src', 'houki1.png');
            subtitle.setAttribute('visible', true);
            step = 1;
          }
        });

        // ② クリックで字幕② → ③ もう一度でほうき移動
        controller.addEventListener('triggerdown', () => {
          const hits = controller.components.raycaster.intersections;
          if (!hits.length || hits[0].object.el !== houki) return;

          if (step === 1) {
            subtitle.setAttribute('src', 'houki2.png');
            step = 2;

          } else if (step === 2) {
            subtitle.setAttribute('visible', false);

            const pos = new THREE.Vector3();
            controller.object3D.getWorldPosition(pos);

            houki.setAttribute("animation__move", {
              property: "position",
              to: `${pos.x} ${pos.y} ${pos.z - 0.5}`,
              dur: 800,
              easing: "easeOutQuad"
            });

            step = 3;
          }
        });
      }
    });
  </script>

  <!-- PNG切替（字幕） -->
  <script>
    AFRAME.registerComponent('subtitle-switcher', {
      init: function () {
        const el = this.el;
        const subtitles = ['teacher1.png', 'teacher2.png'];
        let index = 0;

        el.addEventListener('click', () => {
          index = (index + 1) % subtitles.length;
          el.setAttribute('src', subtitles[index]);
        });
      }
    });
  </script>

  <!-- リセット -->
  <script>
    AFRAME.registerComponent('reset-scene', {
      init: function () {
        this.el.addEventListener('click', () => location.reload());
      }
    });
  </script>

</body>
</html>
