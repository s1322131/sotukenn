<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>VR 魔法杖＋先生モデル＋羽つかみ</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- Super Hands -->
  <script src="https://cdn.jsdelivr.net/gh/wmurphyrd/aframe-super-hands-component@4.0.5/dist/aframe-super-hands.min.js"></script>

  <!-- Physics -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
</head>

<body>
  <a-scene vr-mode-ui="enabled: true" wand-light-control physics="debug: true">

    <!-- 背景 -->
    <a-sky src="back.png" rotation="0 -90 0"></a-sky>

    <!-- カメラ -->
    <a-entity camera look-controls position="0 -3 0"></a-entity>

    <!-- 先生モデル -->
    <a-entity id="teacher"
              gltf-model="teacher11.glb"
              animation-mixer
              position="0 -20 -20"
              rotation="0 10 0"
              scale="14 14 14">
    </a-entity>

    <!-- 箒（掴める） -->
    <a-entity id="houki"
              gltf-model="houki1.glb"
              position="10 -1 -3"
              rotation="0 0 0"
              scale="1 1 1"
              class="grabbable"
              grabbable
              dynamic-body="shape: box; mass: 5"
              shape="box">
    </a-entity>

    <!-- 右手のコントローラー -->
    <a-entity id="rightController"
              laser-controls="hand: right"
              oculus-touch-controls="hand: right; model: false"
              vive-controls="hand: right"
              windows-motion-controls="hand: right"
              daydream-controls="hand: right"
              gearvr-controls="hand: right"
              super-hands
              raycaster="objects: .grabbable, .hoverable; far: 15">

      <!-- 杖 -->
      <a-entity id="wand"
                gltf-model="tsue2.glb"
                scale="0.2 0.2 0.2"
                position="0 0 0"
                rotation="150 121 180">

        <!-- 杖の光球 -->
        <a-sphere id="wandGlow"
                  radius="0.6"
                  color="#88ccff"
                  emissive="#88ccff"
                  emissiveIntensity="2"
                  visible="false"
                  position="3 0 0"
                  animation__pulse="property: scale; dir: alternate; dur: 700; from: 1 1 1; to: 1.25 1.25 1.25; loop: true; easing: easeInOutSine"
                  animation__emissive="property: material.emissiveIntensity; dir: alternate; dur: 900; from: 1.5; to: 3.5; loop: true; easing: easeInOutSine">
        </a-sphere>

        <!-- 杖ライト -->
        <a-entity id="wandLight"
                  light="type: point; intensity: 0; distance: 4; decay: 2"
                  position="3 0 0">
        </a-entity>

      </a-entity>
    </a-entity>

    <!-- 羽（掴める） -->
    <a-entity id="feather"
              gltf-model="hane.glb"
              class="grabbable"
              position="0 -1 -3"
              rotation="0 90 0"
              scale="0.3 0.3 0.3"
              grabbable
              dynamic-body="shape: box; mass: 0.1"
              shape="box">
    </a-entity>

    <!-- テスト用ボックス -->
    <a-box id="testBox"
           class="grabbable"
           grabbable
           hoverable
           color-feedback
           position="-5 0 0"
           depth="0.5"
           height="0.5"
           width="0.5"
           color="#ff8844"
           dynamic-body="shape: box; mass: 1"
           shape="box">
    </a-box>

    <!-- ライト -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>

  </a-scene>

  <!-- 杖ライト制御 -->
  <script>
    AFRAME.registerComponent('wand-light-control', {
      init: function () {
        const controller = document.querySelector('#rightController');
        const glow = document.querySelector('#wandGlow');
        const light = document.querySelector('#wandLight');

        let on = false;
        let lastClick = 0;
        const threshold = 300;

        controller.addEventListener('triggerdown', () => {
          const now = performance.now();

          if (now - lastClick < threshold) {
            on = !on;
            glow.setAttribute('visible', on);
            light.setAttribute('light', 'intensity', on ? 2 : 0);
          }
          lastClick = now;
        });
      }
    });
  </script>

  <!-- トリガーで羽の掴み切り替え -->
  <script>
    AFRAME.registerComponent('toggle-grab-control', {
      init: function () {
        const controller = this.el;
        const targetFeather = document.querySelector('#feather');

        let isGrabbing = false;

        controller.addEventListener('triggerdown', () => {
          isGrabbing = !isGrabbing;

          if (isGrabbing) {
            targetFeather.emit('grab-start', { detail: { hand: controller } }, true);
            console.log('Feather Grab Started');
          } else {
            targetFeather.emit('grab-end', { detail: { hand: controller } }, true);
            console.log('Feather Grab Ended');
          }
        });
      }
    });
  </script>

  <!-- 色変化テスト -->
  <script>
    AFRAME.registerComponent('color-feedback', {
      init: function () {
        const el = this.el;
        const originalColor = el.getAttribute('material').color;

        el.addEventListener('hover-start', () => {
          el.setAttribute('color', '#33ccff');
        });

        el.addEventListener('hover-end', () => {
          el.setAttribute('color', originalColor);
        });

        el.addEventListener('grab-start', () => {
          el.setAttribute('color', '#ff4444');
        });

        el.addEventListener('grab-end', () => {
          el.setAttribute('color', originalColor);
        });
      }
    });
  </script>

</body>
</html>







