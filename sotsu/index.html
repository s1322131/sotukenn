<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>VR 魔法杖＋先生モデル＋羽つかみ</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- Physics -->
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
</head>

<body>
  <a-scene vr-mode-ui="enabled: true" wand-light-control physics="debug: true">

    <!-- 字幕 -->
    <a-plane id="subtitle"
             src="teacher1.png"
             position="0 -5 -15"
             rotation="0 0 0"
             width="8"
             height="5"
             transparent="true"
             shader="flat"
             class="clickable"
             subtitle-switcher>
    </a-plane>

    <!-- 背景 -->
    <a-sky src="back.png" rotation="0 -90 0"></a-sky>

    <!-- カメラ -->
    <a-entity camera look-controls position="0 -3 0"></a-entity>

    <!-- 先生モデル -->
    <a-entity id="teacher"
              gltf-model="teacher11.glb"
              animation-mixer
              position="0 -20 -20"
              rotation="0 10 0"
              scale="14 14 14">
    </a-entity>

    <!-- 右コントローラ -->
    <a-entity id="rightController"
        laser-controls="hand: right"
        raycaster="objects: .interactable; lineColor: red; far: 20"
        simple-grab
        attract-houki
        >
      
      <!-- 杖 -->
      <a-entity id="wand"
                gltf-model="tsue2.glb"
                scale="0.2 0.2 0.2"
                position="0 0 0"
                rotation="150 121 180">

        <!-- 杖の光球 -->
        <a-sphere id="wandGlow"
                  radius="0.6"
                  color="#88ccff"
                  emissive="#88ccff"
                  emissiveIntensity="2"
                  visible="false"
                  position="-5 -3 0">
        </a-sphere>

        <!-- 杖ライト -->
        <a-entity id="wandLight"
                  light="type: point; intensity: 0; distance: 4; decay: 2"
                  position="-5 -3 0">
        </a-entity>

      </a-entity>
    </a-entity>


    <!-- 羽（掴める） -->
    <a-entity id="feather"
              class="interactable grab-target"
              gltf-model="hane.glb"
              position="0 -1 -3"
              rotation="0 90 0"
              scale="0.3 0.3 0.3">
    </a-entity>

    <!-- テスト用ボックス（掴める） -->
    <a-box id="testBox"
           class="interactable grab-target"
           color="#ff8844"
           position="-5 0 -3"
           width="0.9"
           height="0.5"
           depth="0.5">
    </a-box>

    <!-- ほうき（引き寄せられる） -->
    <a-entity id="houki"
              class="interactable houki-target"
              gltf-model="houki1.glb"
              position="10 -1 -3"
              scale="1 1 1">
    </a-entity>


    <!-- ライト -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>

  </a-scene>


  <!-- 杖ライト制御（ダブルトリガー） -->
  <script>
    AFRAME.registerComponent('wand-light-control', {
      init: function () {
        const controller = document.querySelector('#rightController');
        const glow = document.querySelector('#wandGlow');
        const light = document.querySelector('#wandLight');

        let on = false;
        let lastClick = 0;
        const threshold = 300;

        controller.addEventListener('triggerdown', () => {
          const now = performance.now();

          if (now - lastClick < threshold) {
            on = !on;
            glow.setAttribute('visible', on);
            light.setAttribute('light', 'intensity', on ? 2 : 0);
          }
          lastClick = now;
        });
      }
    });
  </script>




  <!-- --------------------------------------------------------------
       1) simple-grab（羽と四角を掴む）superhands無し版
  -------------------------------------------------------------- -->
  <script>
    AFRAME.registerComponent('simple-grab', {
      init: function () {
        const controller = this.el;
        let grabbingEl = null;

        controller.addEventListener('triggerdown', () => {
          const hits = controller.components.raycaster.intersections;
          if (!hits || hits.length === 0) return;

          const target = hits[0].object.el;
          if (target.classList.contains("grab-target")) {
            grabbingEl = target;
            controller.appendChild(grabbingEl);
            grabbingEl.setAttribute("position", "0 0 -0.5");
          }
        });

        controller.addEventListener('triggerup', () => {
          if (!grabbingEl) return;

          const worldPos = new THREE.Vector3();
          grabbingEl.object3D.getWorldPosition(worldPos);

          controller.sceneEl.appendChild(grabbingEl);
          grabbingEl.setAttribute("position",
            `${worldPos.x} ${worldPos.y} ${worldPos.z}`);

          grabbingEl = null;
        });
      }
    });
  </script>



  <!-- --------------------------------------------------------------
       2) attract-houki（ほうきを引き寄せる）
  -------------------------------------------------------------- -->
  <script>
    AFRAME.registerComponent('attract-houki', {
      init: function () {
        const controller = this.el;
        const scene = controller.sceneEl;

        controller.addEventListener("triggerdown", () => {
          const hits = controller.components.raycaster.intersections;
          if (!hits.length) return;

          const target = hits[0].object.el;

          // ほうきだけ反応
          if (!target.classList.contains("houki-target")) return;

          // controller の位置へスーッと移動
          const ctrlPos = new THREE.Vector3();
          controller.object3D.getWorldPosition(ctrlPos);

          target.setAttribute("animation__attract", {
            property: "position",
            to: `${ctrlPos.x} ${ctrlPos.y} ${ctrlPos.z - 0.5}`,
            dur: 600,
            easing: "easeOutQuad"
          });
        });
      }
    });
  </script>



  <!-- PNG切り替え（字幕） -->
  <script>
    AFRAME.registerComponent('subtitle-switcher', {
      init: function () {
        const el = this.el;
        const subtitles = ['teacher1.png', 'teacher2.png'];
        let index = 0;

        el.addEventListener('click', () => {
          index = (index + 1) % subtitles.length;
          el.setAttribute('src', subtitles[index]);
        });
      }
    });
  </script>

</body>
</html>
