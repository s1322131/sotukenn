<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>VR 魔法杖＋先生モデル＋羽つかみ</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/wmurphyrd/aframe-super-hands-component@4.0.5/dist/aframe-super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
</head>
  
<body>
<a-scene vr-mode-ui="enabled: true" wand-light-control physics="debug: true">

    <a-sky src="back.png" rotation="0 -90 0"></a-sky>

    <a-entity camera look-controls position="0 -3 0"></a-entity>

    <a-entity id="teacher"
            gltf-model="teacher11.glb"
            animation-mixer
            position="0 -20 -20"
            rotation="0 10 0"
            scale="14 14 14">
    </a-entity>
  
     <a-entity id="houki"
        gltf-model="houki1.glb"
        position="10 -1 -3"
        rotation="0 0 0"
        scale="1 1 1"
        class="grabbable"
        grabbable
        dynamic-body="shape: box; mass: 5"
        shape="box">
    </a-entity>
      
        <a-entity id="rightController" 
            laser-controls="hand: right" 
            oculus-touch-controls="hand: right; model: false" 
            vive-controls="hand: right" 
            windows-motion-controls="hand: right" 
            daydream-controls="hand: right" 
            gearvr-controls="hand: right"
            super-hands
            raycaster="objects: .grabbable; far: 15">      
      <a-entity id="wand" 
            gltf-model="tsue2.glb"
            scale="0.2 0.2 0.2" 
            position="0 0 0"
            rotation="150 121 180"> 
      <a-sphere id="wandGlow" 
             radius="0.01" 
             color="#88ccff" 
             emissive="#88ccff" 
             emissiveIntensity="2" 
             visible="false" 
             position="0 0.15 0"
              animation__pulse="property: scale; dir: alternate; dur: 700; from: 1 1 1; to: 1.25 1.25 1.25; loop: true; easing: easeInOutSine" 
              animation__emissive="property: material.emissiveIntensity; dir: alternate; dur: 900; from: 1.5; to: 3.5; loop: true; easing: easeInOutSine"> 
      </a-sphere>
      <a-entity id="wandLight" 
             light="type: point; intensity: 0; distance: 4; decay: 2" 
             position="0 0.15 0"> 
      </a-entity> 
    
     </a-entity> 
      
    </a-entity>

        <a-entity id="feather"
            gltf-model="hane.glb"
            class="grabbable"
            position="0 -1 -3"
            rotation="0 90 0"
            scale="0.3 0.3 0.3"
            grabbable dynamic-body="shape: box; mass: 0.1"
            shape="box">
    </a-entity>

    <a-box id="testBox"
         class="grabbable"
         grabbable
         hoverable
         color-feedback
         position="-5 0 0"
         depth="0.5" height="0.5" width="0.5"
         color="#ff8844"
         dynamic-body="shape: box; mass: 1"              
         shape="box">                            
    </a-box>
  
  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>

</a-scene>

<script>
// 杖の光 ON/OFF
AFRAME.registerComponent('wand-light-control', {
  init: function () {
    const controller = document.querySelector('#rightController');
    const glow = document.querySelector('#wandGlow');
    const light = document.querySelector('#wandLight');

    let on = false;
    let lastClick = 0;
    const threshold = 300;

    controller.addEventListener('triggerdown', () => {
      const now = performance.now();
      if (now - lastClick < threshold) {
        on = !on;
        glow.setAttribute('visible', on);
        light.setAttribute('light', 'intensity', on ? 2 : 0);
      }
      lastClick = now;
    });
  }
});
</script>

<script>
AFRAME.registerComponent('toggle-grab-control', {
             init: function () {
                 const controller = this.el; // このコンポーネントがアタッチされるコントローラーエンティティ
                 const targetFeather = document.querySelector('#feather');
                 
                 // 掴み状態を保持するフラグ
                 let isGrabbing = false;
         
                 // トリガーボタンが押されたときの処理
                 controller.addEventListener('triggerdown', () => {
                     // 現在の掴み状態を反転
                     isGrabbing = !isGrabbing;
                     
                     if (isGrabbing) {
                         // 掴み開始 (grab-start イベントを発火)
                         // super-handsは、このイベントを受信すると、raycasterが衝突しているオブジェクトを掴みます。
                         targetFeather.emit('grab-start', { detail: { hand: controller } }, true);
                         console.log('Feather Grab Started');
                     } else {
                         // 掴み終了 (grab-end イベントを発火)
                         targetFeather.emit('grab-end', { detail: { hand: controller } }, true);
                         console.log('Feather Grab Ended');
                     }
                 });
             }
         });
</script>

         <script>
                  AFRAME.registerComponent('color-feedback', {
                    init: function () {
                      const el = this.el;
                  
                      // オリジナル色を保持
                      const originalColor = el.getAttribute('material').color;
                  
                      // 近づいた（hover start）
                      el.addEventListener('hover-start', () => {
                        el.setAttribute('color', '#33ccff');
                      });
                  
                      // 離れた（hover end）
                      el.addEventListener('hover-end', () => {
                        el.setAttribute('color', originalColor);
                      });
                  
                      // 掴んだ（grab start）
                      el.addEventListener('grab-start', () => {
                        el.setAttribute('color', '#ff4444');
                      });
                  
                      // 離した（grab end）
                      el.addEventListener('grab-end', () => {
                        el.setAttribute('color', originalColor);
                      });
                    }
                  });
         </script>

</body>
</html>





